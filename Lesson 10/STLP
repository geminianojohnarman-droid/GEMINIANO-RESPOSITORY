import serial
import serial.tools.list_ports

# Step 1: List all available serial ports
ports = list(serial.tools.list_ports.comports())
if not ports:
    print("No serial ports detected. Make sure your device is connected via USB OTG.")
    exit()  # Stop the program safely

print("Available serial ports:")
for i, p in enumerate(ports):
    print(f"{i}: {p.device} ({p.description})")

# Step 2: Let user choose the port
choice = input("Enter the number of the port you want to use: ")
try:
    port_name = ports[int(choice)].device
except (IndexError, ValueError):
    print("Invalid selection.")
    exit()

# Step 3: Open the selected serial port safely
try:
    ser = serial.Serial(port_name, 9600, timeout=1)
    print(f"Successfully connected to {port_name}")
except serial.SerialException as e:
    print(f"Error opening port {port_name}: {e}")
    exit()

# Step 4: Example communication
try:
    ser.write(b'Hello from Python!\n')  # send data
    line = ser.readline().decode('utf-8').strip()  # read a line
    print("Received:", line)
finally:
    ser.close()
    print("Port closed.")
